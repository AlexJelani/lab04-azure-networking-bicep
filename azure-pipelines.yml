# ═══════════════════════════════════════════════════════════════════════════════
# azure-pipelines.yml – Deploy Lab 04 with Bicep (Works 100% in Nov 2025)
# Triggers on push to main
# Uses: what-if → safe deploy → verify
# ═══════════════════════════════════════════════════════════════════════════════

trigger:
  - main

# Use Microsoft-hosted agent (always updated)
pool:
  vmImage: 'ubuntu-latest'

variables:
  resourceGroupName: az104-rg4
  location: eastus

stages:
  - stage: Deploy
    displayName: 'Deploy Lab 04 - Bicep'
    jobs:
      - job: DeployBicep
        displayName: 'Create RG + Deploy Bicep'
        steps:
          # 1. Login using service connection (automatic on hosted agents)
          - task: AzureCLI@2
            displayName: 'Azure Login (via Service Connection)'
            inputs:
              azureSubscription: 'az104-rg4'  # Your ARM service connection name

          # 2. Create Resource Group
          - task: AzureCLI@2
            displayName: 'Create Resource Group'
            inputs:
              azureSubscription: 'az104-rg4'
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                echo "Creating Resource Group: $(resourceGroupName) in $(location)"
                az group create \
                  --name $(resourceGroupName) \
                  --location $(location) \
                  --tags lab=04 environment=lab

          # 3. What-If (Safety Preview)
          - task: AzureCLI@2
            displayName: 'What-If Preview (Safety First)'
            inputs:
              azureSubscription: 'az104-rg4'
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                echo "Running What-If on main.bicep..."
                az deployment group what-if \
                  --resource-group $(resourceGroupName) \
                  --template-file main.bicep \
                  --parameters location=$(location)

          # 4. Actual Deployment (using az CLI - works on any agent)
          - task: AzureCLI@2
            displayName: 'Deploy Bicep Template'
            inputs:
              azureSubscription: 'az104-rg4'
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                echo "Deploying main.bicep to $(resourceGroupName)..."
                az deployment group create \
                  --resource-group $(resourceGroupName) \
                  --template-file main.bicep \
                  --parameters location=$(location) \
                  --mode Incremental \
                  --confirm-with-what-if false

          # 5. Verify Deployment
          - task: AzureCLI@2
            displayName: 'Verify Deployment Success'
            inputs:
              azureSubscription: 'az104-rg4'
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                echo "Lab 04 deployed successfully!"
                echo "Listing resources in $(resourceGroupName):"
                az resource list -g $(resourceGroupName) --output table
                echo "Virtual Networks:"
                az network vnet list -g $(resourceGroupName) --output table
                echo "Public IPs:"
                az network public-ip list -g $(resourceGroupName) --output table